{% extends "base.html" %}

{% block body %}
<input type="text" id="searchInput" placeholder="Buscar productos..." class="form-control mb-3">

<div class="accordion" id="accordionShoppingList">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne" id="shoppingListTitle">
          Shopping list (<span id="total-price">0.00</span> €)
        </button>
      </h2>
      <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionShoppingList">
        <div class="accordion-body">

            <ol id="product-info" class="list-group list-group-numbered"></ol>
        </div>
      </div>
    </div>
  </div>

<h2>Mercadona products</h2>
<div class="accordion" id="accordionExample">
    {% for category_name, products in products.items %}
    <div class="accordion-item accordion-item-products">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ category_name|slugify }}" aria-expanded="true" aria-controls="collapseOne">
          {{ category_name }}
        </button>
      </h2>
      <div id="{{ category_name|slugify }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
        <div class="accordion-body">
          <ol class="list-group list-group-numbered">
            {% for product in products %}
                <a href="#" class="add-to-cart" data-name="{{ product.name }}" data-price="{{ product.price }}" data-image="{{ product.image }}">
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}" style="width:8rem">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{{product.name}}</div>
                        </div>
                        <span class="badge text-bg-primary rounded-pill">{{product.price}} €</span>
                    </li>
                </a>

            {% endfor %}
            </ol>
        </div>
      </div>
    </div>
    {% endfor %}
</div>

{% endblock body %}

{% block extrajs %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
      const searchInput = document.getElementById('searchInput');
      
      searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        const accordionItems = document.querySelectorAll('.accordion-item-products');
  
        accordionItems.forEach(function(item) {
          const categoryName = item.querySelector('.accordion-button').textContent.toLowerCase();
          const products = item.querySelectorAll('.card');
  
          let categoryMatches = categoryName.includes(filter);
          let productMatches = false;
  
          products.forEach(function(product) {
            const productName = product.querySelector('.card-title').textContent.toLowerCase();
            if (productName.includes(filter)) {
              product.style.display = 'block';
              productMatches = true;
            } else {
              product.style.display = 'none';
            }
          });
  
          if (categoryMatches || productMatches) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const addToCartButtons = document.querySelectorAll('.add-to-cart');
      const productInfoDiv = document.getElementById('product-info');
      const shoppingListTitle = document.getElementById('shoppingListTitle');
  
      let cart = {};
      let totalPrice = 0;
  
      addToCartButtons.forEach(function(button) {
        button.addEventListener('click', function(event) {
          event.preventDefault();
  
          const productName = button.getAttribute('data-name');
          const productPrice = parseFloat(button.getAttribute('data-price'));
          const productImage = button.getAttribute('data-image');
  
          if (cart[productName]) {
            cart[productName].quantity += 1;
          } else {
            cart[productName] = {
              price: productPrice,
              image: productImage,
              quantity: 1
            };
          }
  
          totalPrice += productPrice;
  
          updateAccordionTitle();
  
          updateCartDisplay();
        });
      });
  
      function updateAccordionTitle() {
        shoppingListTitle.textContent = `Shopping list - Total: ${totalPrice.toFixed(2)} €`;
      }
  
      function updateCartDisplay() {
        productInfoDiv.innerHTML = '';
  
        for (let productName in cart) {
          const product = cart[productName];
          productInfoDiv.innerHTML += `
           <li class="list-group-item d-flex justify-content-between align-items-start">
                <img src="${product.image}" class="card-img-top" style="width:4rem;"/>
                <div class="ms-2 me-auto">
                    <div class="fw-bold">${productName} (${product.price} €)</div>
                </div>
                <span class="badge text-bg-primary rounded-pill">${product.quantity}</span>
            </li>
          `;
        }
      }
    });
  </script>
  
  
  
{% endblock extrajs %}